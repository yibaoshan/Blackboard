### Android图形系统（二）驱动层：垂直同步到底要不要开？

对于应用开发工程师来说，虽然我们不需要写驱动程序，但是了解View最终是如何显示到屏幕上还是非常有必要的

本篇是Android图形系列的第二篇文章，依旧是一些关于屏幕的名词解释，和Android系统本身没有太大关系，相较于第一篇文章，本篇重点在于介绍“屏幕刷新机制”相关的知识点

### 一、开篇

在打游戏时偶尔会出现“画面撕裂”的情况，感觉屏幕的上半部分和下半部分的画面分开了

我是撕裂图片

去网上搜“画面撕裂怎么解决”？有人说打开游戏的“垂直同步”选项就好了

底下评论又说不要开垂直同步，开了之后不但显卡会被“锁帧”，还会带来屏幕画面延迟，弊大于利

为什么两边的对于“垂直同步”的看法不一样？垂直同步到底是个什么东西？

更加让人疑惑的是：显示器为什么会发生画面撕裂？

这一切的一切都得从“刷新率”和“帧率”开始讲起

#### 1、什么是刷新率

刷新率的概念诞生自CRT显示器，早期的CRT屏幕显示画面是靠电子束激发屏幕内表面的荧光粉来显示图像的，由于荧光粉被点亮后很快会熄灭，所以电子枪必须循环地不断激发这些点

电子束从左到右、从上到下点亮荧光粉的过程，被称为“逐行扫描”技术

在一秒钟内电子束能够扫描出一幅完整画面的速度，被称为屏幕的刷新率，表示单位为HZ

我是动图

60HZ屏幕就是显示器一秒钟显示60次画面，即1/60秒内出一个画面

LCD液晶屏和OLED屏同样使用“逐行扫描”来刷新屏幕像素，不过由于显示原理发生了变化，屏幕的每个像素点都可以单独控制是否发光，所以LCD/OLED屏幕的“逐行刷新”和CRT显示器上的原理是不一样的，在现在的显示器中，逐行刷新指的是控制器单次会一行或者多行更新像素

这种技术被称为有源矩阵驱动，也就是市场上主流的TFT-LCD屏和AMOLED屏

我是雷军AMOLED屏幕图片

##### 屏幕能不能超频？

以前的大屁股显示器出厂后电子束的扫描速度就固定了，几乎不可能更改

现在的LCD液晶屏和OLED屏就不一样了，一块完整的显示设备主要由显示器件、驱动电路、控制器这三部分组成，刷新率就是写在某个地方的一个值，我们只要能修改掉这个值，就可以实现“屏幕超频”

> - PC端可以在显卡的控制面板中自定义屏幕刷新率
> - 笔记本端可以下载Custom Resolution Utility(简称CRU)写入EDID信息来修改屏幕刷新率
> - Android端可以下载酷安大佬做的“RR屏幕刷新率”APP修改屏幕刷新率，除了APP外，Android端还可以通过adb命令修改frame rate值、刷系统内核的来修改刷新率
> - Mac端可以使用SwitchResX软件来修改屏幕刷新率，这个方案我自己没试过，万一黑屏报废了就不好玩了，写篇文章而已不至于搭上台电脑
> - iPhone端可以把手机寄给我，自己先买部Android手机用，然后去看Android端如何超频的

我是pixel手机截屏

我手里Pixel 3就被我超频到61HZ了，它原先只有可怜的60HZ

对于LCD液晶屏和OLCD屏幕来说，刷新率的高低取决于两点：

一是屏幕自身素质，通常是指屏幕的“灰阶响应时间”，刷新率设置过高会导致屏幕偏色、拖影等问题

二是配套的硬件素质，屏幕供电、贷款总线等，刷新率过高可能导致屏幕无法正常工作，比如显示器黑屏、触摸屏失灵

想要了解屏幕的详细信息可以去[屏库](https://www.panelook.cn/)上查询，最后还是要提醒大家，超频有风险，刷机需谨慎

#### 2、什么是帧率

帧率一直是视频领域中的概念，它的诞生最早可以追溯到1860年无声电影时代，电影分为拍摄和放映两部分

在拍摄视频时，帧率指的是每秒钟记录的画面数量；在播放视频时，帧率指的是每秒钟输出的画面数量

1973年施乐公司发明出第一台带有图形用户界面（GUI）的计算机之后，帧率也被用来表示每秒钟计算机能够渲染出的画面数量

帧率的概率很容易理解，它的难点在于当帧率和刷新率组合在一起时，情况就可能会变的复杂了一些，我们来看几个问题：

> - 显卡每秒能生成250帧画面，但是显示器只有90HZ，多出来的160帧画面有没有意义？是不是白白浪费了显卡性能？
> - 我买了一台144HZ的显示器，但我的显卡很拉胯还没升级，导致玩游戏的平均帧率只有30FPS，显示器会帮我补帧吗？
> - 玩游戏发现画面撕裂，去网上查都说出现撕裂的根本原因在于显卡输出帧的速度比显示器快，买一台高刷显示器即可解决，真的是这样吗？

这几个问题分别对应了“帧率大于刷新率”、“刷新率大于帧率”以及“帧率和刷新频率不匹配导致的画面撕裂”这三种情况，接下来我们就从显卡和屏幕工作原理的角度来聊聊，当刷新率和帧率不匹配时计算机会如何处理？

##### 显卡和显示器之间是如何协同工作的？

首先我们要知道一点，显卡和显示器虽然在同一块主板上，但是它俩互相是不知道彼此的存在的，显卡和显示器完全有可能来自不同的厂家

操作系统启动后会开辟出一块内存专门用于画面显示，这块共享内存被称为“帧缓存区”，也就是我们经常听到的frame buffer，它可以位于显存，也可以位于内存，由操作系统决定如何分配

在不进行任何设置的前提下，操作系统通常使用的是双缓存策略：

> 显示控制器驱动正在读取的是一个帧缓存，我们称之为前缓存
>
> 显卡绘制后写入的另一个帧缓存，称之为后缓存，显卡绘制完一帧后通知CPU交换前后缓存的顺序
>
> 显示器显示刷新的过程，就是不停的切换由前后缓存组成的缓存队列

我是工作原理图片

从流程图可以看出，显示器负责从前缓存读数据，然后每次一行或多行更新像素颜色；显卡负责画图，向后缓存写数据，渲染完成后通知CPU交换帧缓存

在整个的工作流程中，显卡和显示器之间是没有任何联系的，这也是导致画面撕裂的原因

##### 为什么会发生画面撕裂？

下图模拟的是显示器正在刷新屏幕像素，其中上半部分的图像已经刷新完成

我是图片上

而此时显卡也刚好完成下一帧的渲染工作，并触发了交换帧缓存

显示器依旧按照当前的偏移量读取数据，屏幕最终得到的来自两个不同帧缓存拼接的画面，也就是“画面撕裂”

我是图片下

重点来了，屏幕像素点一旦刷新完成，下次刷新要等到16ms以后，刷新率越低等待的时间越长，这也是我们人眼能够察觉到“画面撕裂”的原因

所以，发生画面撕裂的根本原因是：帧缓存的交换随时可能会发生，而一旦显卡在不恰当的时机交换了帧缓存，画面撕裂便有可能被我们察觉

### 二、垂直同步信号

既然画面撕裂的原因是显卡在不恰当的时机交换了帧缓存，那我们让显卡在显示器刷新的这段时间内，不触发交换frame butter的动作不就解决问题了

垂直同步就是用来做这样的事情的

#### 1、什么是垂直同步

具体实现上，我们可以让显示控制器驱动在每次刷新屏幕之后，主动向CPU发起一个中断，代表显示器刷新完成

显卡画面渲染完成以后进入阻塞状态，等收到显示器的完成信号后再去交换帧缓存

我是流程图

显示器发送的中断信号，就被称为垂直同步（VSync）信号

通过增加垂直同步信号的方式，使得每次交换帧缓存的时机变得可控，大大降低了画面撕裂发生的概率

不过，垂直同步在减轻“画面撕裂”的同时，也带来了两个新的问题..

##### 垂直同步的弊端

当显卡的垂直同步功能被置为TRUE以后，每一帧渲染完调用SwapBuffers函数时，都要等待下一次屏幕刷新的时刻到来，才能交换前后缓存并开始执行下一帧…

这就产生了两个新的问题：

一是显卡接收到VSync信号后才去工作，会导致显卡输出的帧率永远不可能大于屏幕的刷新率，可以简单理解为显卡锁帧

二是在等待垂直同步信号的这段时间内，鼠标、键盘等事件不能及时的显示到屏幕上，会导致画面延迟

问题一对大部分人来说还可以接受，显卡性能足够的情况下可以稳定输出60帧，非竞技类游戏的话影响不是很大

但是画面延迟就很难接受了，60HZ的显示器最大延迟能达到十几毫秒，如果玩的是CSGO、PUBG、穿越火线等FPS游戏，十几毫秒的延迟还是很客观的

那有没有什么方法能够解决垂直同步信号带来的弊端呢？

有，三重缓存和自适应同步刷新率

#### 2、什么是三重缓存

三重缓存是在开启了垂直同步的基础上，再增加一个中缓存，和原有的前后缓存组成缓存队列

中缓存保证任何时候都有一帧完整的画画数据等待着交换，显示器读取数据的是前缓存，VSync信号到来后前缓冲和中缓存发生交换

显卡正在写入数据的是后缓存，显卡渲染完一帧画面后，后缓存只和中缓存发生交换

我是原理图

设计三重缓存的初衷是尽可能的降低画面延迟以及减少垂直同步带来的性能浪费

目前Android系统图形更新策略就是采用垂直同步信号+三重缓存的方案

单独开启三重缓存的意义不大

是不想浪费显卡的性能，显卡不必等待垂直同步信号到来才去工作，让显卡尽量跑满60HZ

，三重缓存应用场景比较单一，需要

三重缓存对应的场景是：



加入一个中缓存可以不浪费显卡的性能，

因为增加了一层缓存的缘故，画面的延迟同样也增加了

三重缓存应用场景比较有限，显卡性能强的用不上，显卡性能弱的又不建议开启垂直同步，单独开启三重缓存的意义不大

所以平时比较少听到建议打开三重缓存功能的

#### 3、什么是自适应同步

超过屏幕最大刷新率，按照屏幕最高刷新率来显示

否则，按照显卡输出的帧率来显示

### 三、结语



所以，在显卡性能较低的电脑上，非常不建议开启垂直同步选项，显卡画张图本来就已经很不容易了，碰巧遇到一张简单的图，费老大力画完了打算给屏幕，结果你让我候着等信号？万一下一帧画面比较复杂，等我花完又不知猴年马月了[旺柴]

到这里，为什么会发生画面撕裂的原因就讲完了，我们回头来看开篇提到了三个问题

> - 显卡每秒能生成250帧画面，但是显示器只有90HZ，多出来的160帧画面有没有意义？是不是白白浪费了显卡性能？
>
>   > 当帧率大于刷新率时，显示器最多也只能显示90张画面。至于多出来的画面有没有意义，我觉得对于游戏玩家来说是有意义的尤其是FPS游戏
>   >
>   > 因为屏幕刷新时拿到的总是最新时刻的画面帧，最新帧同时会包含你的键盘和鼠标的处理事件，反映在游戏画面上就是你会觉得操作更流畅鼠标更跟手了
>   >
>   > 我是图片
>
> - 我买了一台144HZ的显示器，但我的显卡很拉胯还没升级，导致玩游戏的平均帧率只有30FPS，显示器会帮我补帧吗？
>
>   > 当刷新率大于帧率时，
>
> - 玩游戏发现画面撕裂，去网上查都说出现撕裂的根本原因在于显卡输出帧的速度比显示器快，买一台高刷显示器即可解决，真的是这样吗？

### 四、参考资料



Ps：我们这儿讲的帧率指的是计算机输出到显示器的帧速率，想了解视频领域的帧率看这里：[传送门](https://www.bilibili.com/video/BV1kE411c7yZ)

